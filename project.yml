title: Training pipeline for Ancient Greek Language Model
description: >
  Reproducible workflows for training the ancient greek spaCy pipeline.

vars:
  lang: "grc"
  config_trf: "transformer"
  config_sm: "cpu"
  model_name_sm: "grc_core_treebanks_sm"
  model_name_trf: "grc_core_treebanks_trf"
  gpu: 0
  package_version: "0.0.0"
  spacy_version: ">=3.0.0"

directories: ["assets", "corpus", "training", "scripts"]

workflows:
  fetch_assets:
    - get_pretraining
    - get_treebanks
    - get_named_entities
  preprocess:
    - install
    - get_treebanks
    - get_pretraining
    - get_named_entities
    - parse
    - convert
  cpu:
    - train_cpu
    - evaluate_cpu
  transformer:
    - train_trf
    - evaluate_trf

commands:
  - name: install
    help: "Install dependencies."
    script:
     - "pip install -r requirements.txt"
    deps:
     - "requirements.txt"
  - name: get_treebanks
    help: "Downloads and cleans treebank data."
    script:
     - "bash scripts/fetch_treebanks.sh"
     - "bash scripts/clean_treebanks.sh"
     - "python3 scripts/join_treebanks.py"
  - name: get_pretraining
    help: "Downloads and cleans pretraining data."
    script:
     - "bash scripts/fetch_pretraining.sh"
     - "bash scripts/clean_pretraining.sh"
  - name: get_named_entities
    help: "Downloads and cleans named entity assets."
    script:
     - "bash scripts/fetch_named_entities.sh"
     - "bash scripts/clean_named_entities.sh"
     - "python3 scripts/prepare_named_entities.py"
  - name: parse
    help: "Parses pretraining dataset."
    script:
      - "python3 scripts/parse_pretraining_corpus.py"
  - name: convert
    help: "Convert CONLL-U files to spacy binaries."
    script:
     - "python3 -m spacy convert assets/treebanks/joint/train.conllu corpus/ --converter conllu -n 10 "
     - "python3 -m spacy convert assets/treebanks/joint/dev.conllu corpus/ --converter conllu -n 10"
     - "python3 -m spacy convert assets/treebanks/joint/test.conllu corpus/ --converter conllu -n 10"

  - name: train_cpu
    help: "Trains a CPU model over the dataset"
    script:
     - "python3 -m spacy train configs/${vars.config_sm}.cfg --output training/${vars.model_name_sm} --paths.train corpus/train.spacy --paths.dev corpus/dev.spacy"
    deps:
      - "corpus/train.spacy"
      - "corpus/dev.spacy"
      - "configs/${vars.config_sm}.cfg"
    outputs:
      - "training/${vars.model_name_sm}"

  - name: train_trf
    help: "Finetunes the Bert based transformer model on the treebanks"
    script:
     - "python3 -m spacy train configs/${vars.config_trf}.cfg --output training/${vars.model_name_trf} --paths.train corpus/train.spacy --paths.dev corpus/dev.spacy --gpu-id"
    deps:
      - "corpus/train.spacy"
      - "corpus/dev.spacy"
      - "configs/${vars.config_trf}.cfg"
    outputs:
      - "training/${vars.model_name_trf}"

  - name: evaluate_cpu
    help: "Evaluate the cpu model on test data & save the metrics"
    script:
      - "python3 -m spacy evaluate training/${vars.model_name_sm}/model-best corpus/test.spacy --output metrics/${vars.model_name_sm}_${vars.package_version}_model-best.json"
      - "python3 -m spacy evaluate training/${vars.model_name_sm}/model-last corpus/test.spacy --output metrics/${vars.model_name_sm}_${vars.package_version}_model-last.json"
    deps:
      - "training/${vars.model_name_sm}"
      - "corpus/test.spacy"
    outputs:
      - "metrics/${vars.model_name_sm}_${vars.package_version}_model-best.json"
      - "metrics/${vars.model_name_sm}_${vars.package_version}_model-last.json"

  - name: evaluate_trf
    help: "Evaluate the Bert based transformer model on test data & save the metrics"
    script:
      - "python3 -m spacy evaluate training/${vars.model_name_trf}/model-best corpus/test.spacy --output metrics/${vars.model_name_trf}_${vars.package_version}_model-best.json --gpu-id 0"
      - "python3 -m spacy evaluate training/${vars.model_name_trf}/model-last corpus/test.spacy --output metrics/${vars.model_name_trf}_${vars.package_version}_model-last.json --gpu-id 0"
    deps:
      - "training/${vars.model_name_trf}"
      - "corpus/test.spacy"
    outputs:
      - "metrics/${vars.model_name_trf}_${vars.package_version}.json"
  - name: package_trf
    help: "Packages Transformer model into a Python wheel"
    script:
     - "mkdir -p packages"
     - "python3 -m spacy package training/${vars.model_name_trf}/model-best packages/${vars.model_name_trf}"